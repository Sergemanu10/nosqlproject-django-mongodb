{% extends 'nosqlproject/base.html' %}
{% block content %}

<h2 class="mb-4 fw-bold text-success">
    ðŸŸ¢ MongoDB Dashboard
</h2>

<p class="text-muted">
    ðŸ”„ RafraÃ®chissement automatique dans
    <span id="countdown" class="fw-bold text-danger">5</span> secondes...
</p>

<a href="{% url 'mongo_dashboard' %}" class="btn btn-outline-success mb-4">
    ðŸ”„ Actualiser maintenant
</a>

<!-- ======================= -->
<!-- CARDS STATISTIQUES -->
<!-- ======================= -->
<div class="row g-4">

    <div class="col-md-3">
        <div class="card bg-dark text-white p-4 shadow">
            <h5>Ã‰tudiants</h5>
            <h2>{{ total_etudiants }}</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-primary text-white p-4 shadow">
            <h5>Enseignants</h5>
            <h2>{{ total_enseignants }}</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-warning text-white p-4 shadow">
            <h5>Cours</h5>
            <h2>{{ total_cours }}</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-danger text-white p-4 shadow">
            <h5>Inscriptions</h5>
            <h2>{{ total_inscriptions }}</h2>
        </div>
    </div>

</div>

<hr class="my-5">

<!-- ======================= -->
<!-- GRAPH -->
<!-- ======================= -->
<h4>ðŸ“Š Inscriptions des 7 derniers jours</h4>
<canvas id="inscriptionChart"></canvas>

<hr class="my-5">

<!-- ======================= -->
<!-- TABLE -->
<!-- ======================= -->
<h4>ðŸ“‹ Derniers Ã‰tudiants</h4>

<table class="table table-striped table-bordered shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Nom</th>
            <th>PrÃ©nom</th>
            <th>Email</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        {% for etudiant in recent_etudiants %}
        <tr>
            <td>{{ etudiant.nom }}</td>
            <td>{{ etudiant.prenom }}</td>
            <td>{{ etudiant.email }}</td>
            <td>{{ etudiant.date_creation }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" class="text-center text-muted">
                Aucun Ã©tudiant trouvÃ©
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ======================= -->
<!-- CHART JS -->
<!-- ======================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const chartData = {{ chart_data|safe }};

    const labels = chartData.map(item => item._id);
    const counts = chartData.map(item => item.count);

    const ctx = document.getElementById('inscriptionChart');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Inscriptions',
                data: counts,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
</script>

<!-- ======================= -->
<!-- AUTO REFRESH 5 SECONDES -->
<!-- ======================= -->
<script>
    let seconds = 5;
    const countdownElement = document.getElementById("countdown");

    const interval = setInterval(function() {
        seconds--;
        countdownElement.textContent = seconds;

        if (seconds <= 0) {
            clearInterval(interval);
            window.location.reload();
        }
    }, 1000);
</script>

{% endblock %}